<!-- Diário e Planejamento da Campanha -->
<div class="campaign-journal-section">
  <p-tabView styleClass="journal-tabs">
    <!-- Aba Diário de Aventuras -->
    <p-tabPanel header="Diário de Aventuras">
      <ng-template pTemplate="header">
        <i class="pi pi-book"></i>
        <span>Diário de Aventuras</span>
      </ng-template>

      <div class="journal-content">
        <!-- Seção A SAGA ATÉ AGORA -->
        <div class="saga-header">
          <h2 class="saga-title">A SAGA ATÉ AGORA</h2>
          <aso-button
            label="Adicionar Ato"
            icon="pi pi-plus"
            severity="warn"
            (eventClick)="addJournalEntry()"
            class="add-entry-btn"
          ></aso-button>
        </div>

        <!-- Lista de entradas do diário -->
        <div class="journal-entries">
          <p-accordion
            [multiple]="true"
            styleClass="journal-accordion"
            (onClose)="onAccordionToggle($event)"
            (onOpen)="onAccordionToggle($event)"
          >
            @for (entry of journalEntries(); track entry.id) {
            <p-accordionTab>
              <ng-template pTemplate="header">
                <div class="accordion-entry-header">
                  @if (editingJournalTitle() === entry.id) {
                  <aso-input
                    [ngModel]="editingTitleValue()"
                    (ngModelChange)="editingTitleValue.set($event)"
                    class="entry-title-input"
                    (keyup.enter)="saveJournalTitle(entry.id)"
                    (keyup.escape)="cancelJournalTitleEdit()"
                    (click)="$event.stopPropagation()"
                    (keydown)="$event.stopPropagation()"
                    (keyup)="$event.stopPropagation()"
                    (keypress)="$event.stopPropagation()"
                    (input)="$event.stopPropagation()"
                    (keydown.space)="$event.stopPropagation()"
                    (keyup.space)="$event.stopPropagation()"
                  ></aso-input>
                  } @else {
                  <span class="entry-title">{{ entry.title }}</span>
                  }
                  <div class="entry-actions">
                    @if (editingJournalTitle() === entry.id) {
                    <aso-button
                      icon="pi pi-check"
                      variant="text"
                      size="small"
                      severity="success"
                      (eventClick)="saveJournalTitle(entry.id); $event.stopPropagation()"
                    ></aso-button>
                    <aso-button
                      icon="pi pi-times"
                      variant="text"
                      size="small"
                      severity="secondary"
                      (eventClick)="cancelJournalTitleEdit(); $event.stopPropagation()"
                    ></aso-button>
                    } @else {
                    <aso-button
                      icon="pi pi-plus"
                      variant="text"
                      size="small"
                      (eventClick)="addChapter(entry.id); $event.stopPropagation()"
                    ></aso-button>
                    <aso-button
                      icon="pi pi-pencil"
                      variant="text"
                      size="small"
                      (eventClick)="editJournalTitle(entry.id); $event.stopPropagation()"
                    ></aso-button>
                    <aso-button
                      icon="pi pi-trash"
                      variant="text"
                      size="small"
                      severity="danger"
                      (eventClick)="deleteJournalEntry(entry.id); $event.stopPropagation()"
                    ></aso-button>
                    }
                  </div>
                </div>
              </ng-template>

              <!-- Conteúdo da entrada -->
              <div class="accordion-entry-content">
                @if (editingJournal() === entry.id) {
                <div class="edit-mode">
                  <aso-textarea
                    [ngModel]="entry.content"
                    #contentTextarea
                    placeholder="Descreva os eventos deste ato da aventura..."
                    class="w-full entry-textarea"
                  ></aso-textarea>
                  <div class="edit-actions">
                    <aso-button
                      label="Salvar"
                      icon="pi pi-check"
                      severity="success"
                      size="small"
                      (eventClick)="saveJournalEntry(entry.id, contentTextarea.value)"
                    ></aso-button>
                    <aso-button
                      label="Cancelar"
                      icon="pi pi-times"
                      severity="secondary"
                      size="small"
                      (eventClick)="editingJournal.set(null)"
                    ></aso-button>
                  </div>
                </div>
                } @else {

                <!-- Seção de Capítulos -->
                <div class="chapters-section">
                  <!-- Lista de Capítulos -->
                  @if (entry.chapters.length > 0) {
                  <div class="chapters-list">
                    @for (chapter of entry.chapters; track chapter.id) {
                    <div class="chapter-item">
                      <div class="chapter-header">
                        <h4 class="chapter-title">{{ chapter.title }}</h4>
                        <div class="chapter-actions">
                          <aso-button
                            icon="pi pi-pencil"
                            variant="text"
                            size="small"
                            severity="secondary"
                            (eventClick)="editChapter(entry.id, chapter.id)"
                            class="chapter-edit-btn"
                          ></aso-button>
                          <aso-button
                            icon="pi pi-trash"
                            variant="text"
                            size="small"
                            severity="danger"
                            (eventClick)="deleteChapter(entry.id, chapter.id)"
                            class="chapter-delete-btn"
                          ></aso-button>
                        </div>
                      </div>
                      <div class="chapter-content">
                        @if (chapter.content) {
                        <p class="chapter-text">{{ chapter.content }}</p>
                        } @else {
                        <p class="chapter-placeholder">
                          Clique no ícone de edição para adicionar o conteúdo
                          deste capítulo...
                        </p>
                        }
                      </div>
                    </div>
                    }
                  </div>
                  } @else {
                  <div class="no-chapters">
                    <p class="no-chapters-text">
                      Nenhum capítulo adicionado ainda. Clique no botão
                      "Adicionar Capítulo" para começar a escrever sua história.
                    </p>
                  </div>
                  }
                </div>

                }
              </div>
            </p-accordionTab>
            }
          </p-accordion>

          <!-- Campo para novo ato - APÓS os accordions -->
          @if (pendingNewAct() === 'creating') {
          <div class="new-act-input">
            <div class="new-act-form">
              <aso-input
                [ngModel]="newActTitle()"
                placeholder="Digite o título do ato..."
                class="pending-act-input w-full"
                (ngModelChange)="newActTitle.set($event)"
                (keyup.enter)="confirmNewAct()"
                (keyup.escape)="cancelNewAct()"
                (click)="$event.stopPropagation()"
                (keydown)="$event.stopPropagation()"
                (keyup)="$event.stopPropagation()"
                (keypress)="$event.stopPropagation()"
                (input)="$event.stopPropagation()"
                (focus)="$event.stopPropagation()"
                #newActInput
              ></aso-input>
              <div class="new-act-actions">
                <aso-button
                  icon="pi pi-check"
                  severity="success"
                  size="small"
                  (eventClick)="confirmNewAct()"
                ></aso-button>
                <aso-button
                  icon="pi pi-times"
                  severity="secondary"
                  size="small"
                  (eventClick)="cancelNewAct()"
                ></aso-button>
              </div>
            </div>
          </div>
          }
        </div>
      </div>
    </p-tabPanel>

    <!-- Aba Planejamento do Mestre -->
    <p-tabPanel header="Planejamento do Mestre">
      <ng-template pTemplate="header">
        <i class="pi pi-cog"></i>
        <span>Planejamento do Mestre</span>
      </ng-template>

      <div class="planning-content">
        <!-- Cabeçalho da seção -->
        <div class="planning-header">
          <h2 class="planning-title">NOTAS PARA A PRÓXIMA SESSÃO</h2>
          <aso-button
            label="Adicionar Ideia"
            icon="pi pi-plus"
            severity="warn"
            (eventClick)="addPlanningNote()"
            class="add-note-btn"
          ></aso-button>
        </div>

        <!-- Input para nova nota -->
        @if (newPlanningContent()) {
        <div class="new-note-input">
          <aso-textarea
            [(ngModel)]="newPlanningContent"
            placeholder="Digite sua ideia ou nota de planejamento..."
            class="w-full"
            (keyup.enter)="addPlanningNote()"
          ></aso-textarea>
        </div>
        }

        <!-- Lista de notas de planejamento -->
        <div class="planning-notes">
          @if (planningNotes().length > 0) { @for (note of planningNotes();
          track note.id) {
          <div class="planning-note-card">
            @if (editingPlanning() === note.id) {
            <div class="edit-mode">
              <aso-textarea
                [ngModel]="note.content"
                #noteTextarea
                class="w-full note-textarea"
              ></aso-textarea>
              <div class="edit-actions">
                <aso-button
                  icon="pi pi-check"
                  severity="success"
                  size="small"
                  (eventClick)="savePlanningNote(note.id, noteTextarea.value)"
                ></aso-button>
                <aso-button
                  icon="pi pi-times"
                  severity="secondary"
                  size="small"
                  (eventClick)="editingPlanning.set(null)"
                ></aso-button>
              </div>
            </div>
            } @else {
            <div class="view-mode">
              <p class="note-text">{{ note.content }}</p>
              <div class="note-actions">
                <aso-button
                  icon="pi pi-pencil"
                  variant="text"
                  size="small"
                  (eventClick)="editPlanningNote(note.id)"
                ></aso-button>
                <aso-button
                  icon="pi pi-trash"
                  variant="text"
                  size="small"
                  severity="danger"
                  (eventClick)="deletePlanningNote(note.id)"
                ></aso-button>
              </div>
            </div>
            }
          </div>
          } } @else {
          <div class="empty-planning">
            <i class="pi pi-lightbulb"></i>
            <p>Ainda não há notas de planejamento. Adicione suas ideias!</p>
          </div>
          }
        </div>

        <!-- Botão para sugestões de IA (futuro) -->
        <div class="ai-suggestions">
          <aso-button
            label="Pedir Sugestões para IA"
            icon="pi pi-android"
            variant="outlined"
            class="w-full ai-btn"
          ></aso-button>
        </div>
      </div>
    </p-tabPanel>
  </p-tabView>
</div>

<!-- Dialog de capítulos -->
<aso-chapter-dialog
  [visible]="chapterDialogVisible()"
  [data]="chapterDialogData()"
  (save)="onChapterSave($event)"
  (cancelDialog)="onChapterCancel()"
></aso-chapter-dialog>

<!-- Dialog de confirmação e Toast -->
<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>
