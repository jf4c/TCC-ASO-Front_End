<!-- Diário e Planejamento da Campanha -->
<div class="campaign-journal-section">
  <p-toast />
  <p-confirmDialog />

  <p-tabView styleClass="journal-tabs">
    <!-- Aba Diário de Aventuras -->
    <p-tabPanel header="Diário de Aventuras">
      <ng-template pTemplate="header">
        <i class="pi pi-book"></i>
        <span>Diário de Aventuras</span>
      </ng-template>

      <div class="journal-content">
        <!-- Seção A SAGA ATÉ AGORA -->
        <div class="saga-header">
          <h2 class="saga-title">A SAGA ATÉ AGORA</h2>
          <aso-button
            *ngIf="isGameMaster()"
            label="Adicionar Ato"
            icon="pi pi-plus"
            severity="warn"
            (eventClick)="addAct()"
            class="add-entry-btn"
          ></aso-button>
        </div>

        <!-- Novo Ato Inline -->
        <div class="new-act-input" *ngIf="pendingNewAct()">
          <div class="new-act-form">
            <aso-input
              [(ngModel)]="newActTitle"
              placeholder="Digite o título do novo ato (ex: ATO I: O CHAMADO PARA A AVENTURA)"
              inputId="newActInput"
              (keyup.enter)="confirmNewAct()"
              (keyup.escape)="cancelNewAct()"
            />
            <div class="new-act-actions">
              <aso-button
                icon="pi pi-check"
                severity="success"
                size="small"
                (eventClick)="confirmNewAct()"
              />
              <aso-button
                icon="pi pi-times"
                severity="secondary"
                size="small"
                (eventClick)="cancelNewAct()"
              />
            </div>
          </div>
        </div>

        <!-- Loading -->
        <div class="loading-container" *ngIf="loading()">
          <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
          <p>Carregando diário...</p>
        </div>

        <!-- Lista de atos -->
        <div class="empty-state" *ngIf="!loading() && acts().length === 0">
          <i class="pi pi-book" style="font-size: 3rem; opacity: 0.3"></i>
          <p>Nenhum ato registrado ainda</p>
          <p class="empty-hint">Clique em "Adicionar Ato" para começar a saga</p>
        </div>

        <div class="journal-entries" *ngIf="!loading() && acts().length > 0">
          <p-accordion [multiple]="true" styleClass="journal-accordion">
            <p-accordionTab *ngFor="let act of acts(); trackBy: trackByActId">
                  <ng-template pTemplate="header">
                    <div class="accordion-entry-header">
                      <h3 class="entry-title">{{ act.title }}</h3>
                      <div class="entry-actions" *ngIf="isGameMaster()">
                        <aso-button
                          icon="pi pi-plus"
                          variant="text"
                          size="small"
                          (eventClick)="addChapter(act); $event.stopPropagation()"
                        ></aso-button>
                        <aso-button
                          icon="pi pi-pencil"
                          variant="text"
                          size="small"
                          (eventClick)="editAct(act); $event.stopPropagation()"
                        ></aso-button>
                        <aso-button
                          icon="pi pi-trash"
                          variant="text"
                          size="small"
                          severity="danger"
                          (eventClick)="deleteAct(act); $event.stopPropagation()"
                        ></aso-button>
                      </div>
                    </div>
                  </ng-template>

                  <!-- Capítulos do ato -->
                  <div class="act-content">
                    <div class="act-chapters">
                      <div class="empty-chapters" *ngIf="act.chapters.length === 0">
                        <p>Nenhum capítulo neste ato ainda</p>
                        <aso-button
                          *ngIf="isGameMaster()"
                          label="Adicionar Primeiro Capítulo"
                          icon="pi pi-plus"
                          size="small"
                          (eventClick)="addChapter(act)"
                        ></aso-button>
                      </div>
                      <ng-container *ngIf="act.chapters.length > 0">
                        <div class="chapter-entry" *ngFor="let chapter of act.chapters; trackBy: trackByChapterId">
                          <div class="chapter-header">
                            <h4 class="chapter-title">{{ chapter.title }}</h4>
                            <div class="chapter-actions" *ngIf="isGameMaster()">
                              <aso-button
                                icon="pi pi-pencil"
                                variant="text"
                                size="small"
                                (eventClick)="editChapter(act.id, chapter)"
                              ></aso-button>
                              <aso-button
                                icon="pi pi-trash"
                                variant="text"
                                size="small"
                                severity="danger"
                                (eventClick)="deleteChapter(act.id, chapter.id)"
                              ></aso-button>
                            </div>
                          </div>
                          <div class="chapter-content">
                            <p>{{ chapter.content || 'Sem conteúdo' }}</p>
                          </div>
                        </div>
                      </ng-container>
                    </div>
                  </div>
                </p-accordionTab>
              </p-accordion>
            </div>
      </div>
    </p-tabPanel>

    <!-- Aba Planejamento do Mestre -->
    <p-tabPanel header="Planejamento do Mestre" *ngIf="isGameMaster()">
      <ng-template pTemplate="header">
        <i class="pi pi-lightbulb"></i>
        <span>Planejamento do Mestre</span>
      </ng-template>

      <div class="planning-content">
        <div class="planning-header">
          <h3>Notas Privadas do Mestre</h3>
          <div class="planning-header-actions">
            <aso-button
              [label]="isGeneratingIdeas() ? 'Gerando...' : 'Ideias de IA'"
              [icon]="isGeneratingIdeas() ? 'pi pi-spin pi-spinner' : 'pi pi-sparkles'"
              severity="secondary"
              (eventClick)="generateAIIdeas()"
              [disabled]="isGeneratingIdeas()"
              [loading]="isGeneratingIdeas()"
            ></aso-button>
            <aso-button
              label="Nova Nota"
              icon="pi pi-plus"
              severity="help"
              (eventClick)="addMasterNote()"
            ></aso-button>
          </div>
        </div>

        <div class="planning-hint">
          <i class="pi pi-info-circle"></i>
          <span
            >Use esta seção para anotar ideias, NPCs importantes, plot twists
            planejados, ou qualquer informação que não deve ser compartilhada com
            os jogadores.</span
          >
        </div>

        <!-- Lista de notas -->
        <div class="empty-state" *ngIf="masterNotes().length === 0">
          <i class="pi pi-lightbulb" style="font-size: 3rem; opacity: 0.3"></i>
          <p>Nenhuma nota de planejamento ainda</p>
          <p class="empty-hint">Comece a organizar suas ideias para a campanha</p>
        </div>
        <div class="planning-notes" *ngIf="masterNotes().length > 0">
          <div class="planning-note" *ngFor="let note of masterNotes(); trackBy: trackByNoteId">
            <div class="note-header">
              <span class="note-date">{{
                note.createdAt | date: 'dd/MM/yyyy HH:mm'
              }}</span>
              <div class="note-actions">
                <aso-button
                  icon="pi pi-pencil"
                  variant="text"
                  size="small"
                  (eventClick)="editMasterNote(note)"
                ></aso-button>
                <aso-button
                  icon="pi pi-trash"
                  variant="text"
                  size="small"
                  severity="danger"
                  (eventClick)="deleteMasterNote(note.id)"
                ></aso-button>
              </div>
            </div>
            <div class="note-content">
              <p>{{ note.content }}</p>
            </div>
          </div>
        </div>

        <!-- Exibir ideias geradas -->
        <div class="ai-ideas-display" *ngIf="campaignIdeas().length > 0">
          <h4 class="ideas-title">
            <i class="pi pi-sparkles"></i>
            Ideias Geradas pela IA
          </h4>
          <div class="ideas-list">
            <div class="idea-item" *ngFor="let idea of campaignIdeas(); let i = index">
              <span class="idea-number">{{ i + 1 }}</span>
              <p class="idea-text">{{ idea }}</p>
            </div>
          </div>
        </div>

        <!-- Botão para sugestões de IA -->
        <div class="ai-suggestions">
          <aso-button
            label="Pedir Sugestões para IA"
            icon="pi pi-sparkles"
            variant="outlined"
            class="w-full ai-btn"
            (eventClick)="requestAISuggestions()"
          ></aso-button>
        </div>
      </div>
    </p-tabPanel>
  </p-tabView>
</div>

<!-- Dialog de Ato -->
<aso-act-dialog
  [visible]="actDialogVisible()"
  [data]="actDialogData()"
  (save)="onActSave($event)"
  (cancelDialog)="onActCancel()"
/>

<!-- Dialog de Capítulo -->
<aso-chapter-dialog
  [visible]="chapterDialogVisible()"
  [data]="chapterDialogData()"
  (save)="onChapterSave($event)"
  (cancelDialog)="onChapterCancel()"
/>

<!-- Dialog de Nota do Mestre -->
<aso-master-note-dialog
  [visible]="masterNoteDialogVisible()"
  [data]="masterNoteDialogData()"
  (save)="onMasterNoteSave($event)"
  (cancelDialog)="onMasterNoteCancel()"
/>
