<div class="view-character-container">
  <p-toast />
  <p-confirmDialog />

  <!-- Loading State -->
  @if (isLoading()) {
  <div class="loading-state">
    <i class="pi pi-spinner pi-spin"></i>
    <p>Carregando personagem...</p>
  </div>
  }

  <!-- Character Details -->
  @if (!isLoading() && character()) {
  <div class="character-detail">
    <!-- Header -->
    <div class="character-header">
      <button
        pButton
        icon="pi pi-arrow-left"
        class="back-button"
        (click)="onBack()"
        label="Voltar"
      ></button>
      
      <div class="header-actions">
        @if (!isEditMode() && !isInCampaign()) {
        <button
          pButton
          icon="pi pi-pencil"
          label="Editar"
          class="edit-button"
          (click)="onEnableEdit()"
        ></button>
        <button
          pButton
          icon="pi pi-trash"
          label="Deletar"
          class="delete-button"
          (click)="onDeleteCharacter()"
        ></button>
        } @else if (!isEditMode() && isInCampaign()) {
        <button
          pButton
          icon="pi pi-arrow-up"
          label="Level Up"
          class="levelup-button"
          (click)="onLevelUp()"
        ></button>
        <button
          pButton
          icon="pi pi-trash"
          label="Deletar"
          class="delete-button"
          (click)="onDeleteCharacter()"
          [disabled]="true"
        ></button>
        } @else {
        <button
          pButton
          icon="pi pi-times"
          label="Cancelar"
          class="cancel-button"
          (click)="onCancelEdit()"
          [disabled]="isSaving()"
        ></button>
        <button
          pButton
          icon="pi pi-check"
          label="Salvar"
          class="save-button"
          (click)="onSaveChanges()"
          [disabled]="isSaving() || editForm.invalid"
        ></button>
        }
      </div>
    </div>

    <!-- Campaign Warning -->
    @if (isInCampaign()) {
    <div class="campaign-warning">
      <i class="pi pi-info-circle"></i>
      <span>
        Este personagem está em uma campanha.
        Alguns campos não podem ser editados.
      </span>
    </div>
    }

    <!-- Character Image & Basic Info -->
    <div class="character-main">
      <div class="character-image-wrapper">
        <div class="character-image" [ngStyle]="{'background-image': characterImageUrl() ? 'url(' + characterImageUrl() + ')' : 'none'}">
          @if (!characterImageUrl()) {
          <div class="image-placeholder">
            <i class="pi pi-user"></i>
          </div>
          }
        </div>
        @if (isEditMode()) {
        <button
          pButton
          icon="pi pi-images"
          label="Trocar Imagem"
          class="change-image-button"
          (click)="onOpenImageDialog()"
        ></button>
        }
      </div>

      <div class="character-basic-info">
        <form [formGroup]="editForm">
          <!-- Nome destacado -->
          <div class="character-name-section">
            @if (!isEditMode()) {
            <h1 class="character-name-display">{{ character()!.name }}</h1>
            @if (isInCampaign()) {
            <div class="campaign-badge">
              <i class="pi pi-users"></i>
              <span>Em Campanha</span>
            </div>
            }
            } @else {
            <input
              pInputText
              id="name"
              formControlName="name"
              [disabled]="isFieldLocked('name')"
              class="character-name-input"
            />
            @if (isFieldLocked('name')) {
            <small class="field-locked">
              <i class="pi pi-lock"></i> Bloqueado (personagem em campanha)
            </small>
            }
            }
          </div>

          <!-- Raça e Classe -->
          <div class="info-grid">
            <div class="info-card">
              <span class="info-label">Raça</span>
              <span class="info-value">{{ character()!.ancestry.name }}</span>
            </div>
            <div class="info-card">
              <span class="info-label">Classe</span>
              <span class="info-value">{{ character()!.class.name }}</span>
            </div>
          </div>

          <!-- Nível, HP, Mana -->
          <div class="stats-grid">
            <div class="stat-card">
              <span class="stat-label">Nível</span>
              <span class="stat-value stat-level">{{ character()!.level }}</span>
            </div>
            <div class="stat-card stat-hp">
              <i class="pi pi-heart-fill stat-icon"></i>
              <div class="stat-content">
                <span class="stat-label">HP</span>
                <span class="stat-value">{{ health() }}</span>
              </div>
            </div>
            <div class="stat-card stat-mana">
              <i class="pi pi-bolt stat-icon"></i>
              <div class="stat-content">
                <span class="stat-label">Mana</span>
                <span class="stat-value">{{ mana() }}</span>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Attributes and Skills Side by Side -->
    <div class="attributes-skills-container">
      <!-- Attributes (sempre readonly) -->
      <div class="character-section">
        <h3 class="section-title">
          <i class="pi pi-star-fill"></i>
          Atributos
        </h3>
        <div class="attributes-grid">
          <div class="attribute-card">
            <label>Força</label>
            <span class="attribute-value">{{ modifiers().modStrength >= 0 ? '+' : '' }}{{ modifiers().modStrength }}</span>
          </div>
          <div class="attribute-card">
            <label>Destreza</label>
            <span class="attribute-value">{{ modifiers().modDexterity >= 0 ? '+' : '' }}{{ modifiers().modDexterity }}</span>
          </div>
          <div class="attribute-card">
            <label>Constituição</label>
            <span class="attribute-value">{{ modifiers().modConstitution >= 0 ? '+' : '' }}{{ modifiers().modConstitution }}</span>
          </div>
          <div class="attribute-card">
            <label>Inteligência</label>
            <span class="attribute-value">{{ modifiers().modIntelligence >= 0 ? '+' : '' }}{{ modifiers().modIntelligence }}</span>
          </div>
          <div class="attribute-card">
            <label>Sabedoria</label>
            <span class="attribute-value">{{ modifiers().modWisdom >= 0 ? '+' : '' }}{{ modifiers().modWisdom }}</span>
          </div>
          <div class="attribute-card">
            <label>Carisma</label>
            <span class="attribute-value">{{ modifiers().modCharisma >= 0 ? '+' : '' }}{{ modifiers().modCharisma }}</span>
          </div>
        </div>
        @if (isEditMode()) {
        <small class="field-locked attributes-locked">
          <i class="pi pi-lock"></i> Atributos não podem ser editados
        </small>
        }
      </div>

      <!-- Skills -->
      @if (character()!.skills && character()!.skills.length > 0) {
      <div class="character-section">
        <h3 class="section-title">
          <i class="pi pi-bolt"></i>
          Perícias
        </h3>
        <div class="skills-list">
          @for (skill of character()!.skills; track skill.id) {
          <div class="skill-item">
            <strong>{{ skill.name }}</strong>
            @if (skill.description) {
            <p>{{ skill.description }}</p>
            }
          </div>
          }
        </div>
      </div>
      }
    </div>

    <!-- Backstory -->
    @if (!isEditMode()) {
    <div class="character-section">
      <h3 class="section-title">
        <i class="pi pi-book"></i>
        História
      </h3>
      <div class="backstory-content">
        {{ character()!.backstory || 'Nenhuma história cadastrada.' }}
      </div>
    </div>
    } @else {
    <aso-backstory-editor
      [initialBackstory]="character()!.backstory || null"
      [characterName]="character()!.name"
      [ancestryName]="character()!.ancestry.name"
      [className]="character()!.class.name"
      [attributes]="formatAttributes(character()!.modifiers)"
      [skills]="formatSkills(character()!.skills)"
      [disabled]="isFieldLocked('backstory')"
      (backstoryChange)="onBackstoryChange($event)"
    />
    }
  </div>
  }
</div>
